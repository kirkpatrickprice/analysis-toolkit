# Process Scripts

The Process Scripts module (formerly known as `adv-searchfor`) is a powerful tool for analyzing and processing the results generated by KirkpatrickPrice's OS-specific collection scripts. It provides flexible search capabilities, automated analysis, and comprehensive reporting through Excel workbooks.

## Overview

Process Scripts processes text files generated by the following collection scripts:
- [Linux Audit Scripts](https://github.com/kirkpatrickprice/linux-audit-scripts) 
- [Windows Audit Scripts](https://github.com/kirkpatrickprice/windows-audit-scripts)
- [MacOS Auditor](https://github.com/kirkpatrickprice/macos-auditor)

The tool automatically detects the operating system family of each processed file and organizes results accordingly.

## Usage

### Basic Usage

Process all text files in the current directory using default configuration:
```bash
kpat_cli scripts
```

Process files with a specific configuration:
```bash
kpat_cli scripts --conf audit-windows.yaml
```

Process files in a specific directory:
```bash
kpat_cli scripts --start-dir /path/to/results
```

### Command Line Options

| Option | Short | Description | Default |
|--------|-------|-------------|---------|
| `--conf` | `-c` | YAML configuration file to specify search options | `audit-all.yaml` |
| `--start-dir` | `-d` | Directory to start searching for files | `./` |
| `--filespec` | `-f` | File specification pattern to match | `*.txt` |
| `--out-path` | `-o` | Output directory for results files | `results/` |
| `--verbose` | `-v` | Enable verbose output | `false` |

### Information Options

| Option | Description |
|--------|-------------|
| `--list-audit-configs` | List all available audit configuration files |
| `--list-sections` | List all section headers found in source files |
| `--list-source-files` | List all files found matching the filespec |
| `--list-systems` | Print system details found in source files |

## Configuration Files

The Process Scripts module uses YAML configuration files to define search patterns and analysis rules. These files are located in the `conf.d/` directory.

### Available Configurations
#### Default All-Inclusinve Check
- `audit-all.yaml` - Comprehensive checks for all operating systems

#### Operating System Specific
- `audit-windows.yaml` - Windows-specific checks and searches
- `audit-linux.yaml` - Linux-specific checks and searches  
- `audit-macos.yaml` - macOS-specific checks and searches

#### Category Specific
- `audit-linux-logging.yaml` - Linux logging configuration analysis
- `audit-linux-network.yaml` - Linux network configuration analysis
- `audit-linux-security.yaml` - Linux security settings analysis
- `audit-linux-services.yaml` - Linux service configuration analysis
- `audit-linux-ssh.yaml` - Linux SSH configuration analysis
- `audit-linux-system.yaml` - Linux system configuration analysis
- `audit-linux-users.yaml` - Linux user and group analysis
- `audit-linux-worldfiles.yaml` - Linux world-writable files analysis
- `audit-windows-logging.yaml` - Windows logging configuration analysis
- `audit-windows-network.yaml` - Windows network configuration analysis
- `audit-windows-security-software.yaml` - Windows security software analysis
- `audit-windows-system.yaml` - Windows system configuration analysis
- `audit-windows-users.yaml` - Windows user and group analysis

### Custom Configuration Files

You can create custom YAML configuration files to define your own search patterns and analysis rules. Configuration files support:

- **Regular expression searches** - Pattern matching with capture groups
- **System filtering** - Target specific operating systems or versions
- **Result grouping** - Organize results by various criteria
- **Excel formatting** - Custom worksheet and formatting options
- **Include statements** - Reference other configuration files

#### Basic Configuration Structure

```yaml
---
# Global configuration options (optional)
global:
  sys_filter:
    - attr: os_family
      comp: eq
      value: Linux

# Include other configuration files
include_windows_base:
  files:
    - audit-windows.yaml

# Custom search configuration
my_custom_search:
  regex: 'System_ServiceStatus::(?P<ServiceName>\w+)::(?P<Status>\w+)'
  field_list:
    - ServiceName
    - Status
  maxResults: 100
  sysFilter:
    osFamily: 
      - Windows
```

## Output

### Excel Workbooks

Results are exported to Excel workbooks with the following features:

- **Separate worksheets** for each operating system family (Windows, Linux, Darwin)
- **Formatted headers** with freeze panes for easy navigation
- **Color coding** for different result types
- **Summary statistics** on separate worksheets
- **System summary** for details on which systems were identified

### File Naming Convention

Output files follow the pattern:
```
<OSFamily>_search_results-<timestamp>.xlsx
```

Examples:
- `Windows_search_results-20250628-143022.xlsx`
- `Linux_search_results-20250628-143022.xlsx`
- `Darwin_search_results-20250628-143022.xlsx`

## System Detection

The tool automatically detects system information from processed files:

### Supported Script Versions
- **KPNIXVERSION** - Linux audit script results
- **KPWINVERSION** - Windows audit script results  
- **KPMACVERSION** - macOS audit script results

### Extracted System Information
- System hostname
- Operating system family and version
- Script version used for data collection
- Build information and patch levels

## Advanced Features

See [YAML Help](https://github.com/kirkpatrickprice/analysis-toolkit/blob/main/src/process_scripts/YAML Help.md)

## Examples

### Analyze Windows Systems Only

```bash
kpat_cli scripts --conf audit-windows.yaml --start-dir /audit-results/windows
```

### Verbose Progress Reporting with Per-Search Results

```bash
kpat_cli scripts --verbose
```

### List Available Configurations

```bash
kpat_cli scripts --list-audit-configs
```

### Analyze Specific File Types

```bash
kpat_cli scripts --filespec "server-*.txt" --conf audit-linux-services.yaml
```

## Integration with Collection Scripts

### File Format Requirements

Process Scripts expects input files generated by KP audit scripts with:

- **Header information** containing script version and system details
- **Structured data** with consistent field separators (e.g. `System_PendingUpdates::`)

### Supported Content Sections

The tool recognizes various section types:
- System information and configuration
- Service status and configuration
- User and group information
- Network configuration
- Security settings
- Log file contents
- Package and software information

## Performance and Scalability

- **Memory-efficient** streaming for large files
- **Configurable result limits** to manage output size
- **Progress indicators** for long-running analyses

## Troubleshooting

### Common Issues

**No files found:**
```bash
# Check file specification and directory
kpat_cli scripts --list-source-files --start-dir /your/path
```

**System detection failures:**
```bash
# Check system information extraction
kpat_cli scripts --list-systems
```

### Debug Options

Enable verbose mode for detailed processing information:
```bash
kpat_cli scripts --verbose --conf your-config.yaml
```

## Dependencies
### Pre-Requisites

- **Python 3.12+**

### Automatically Installed
- **Pydantic** for data modeling and validation
- **pandas** and **openpyxl** for Excel output generation
- **PyYAML** for configuration file parsing
- **click** for command-line interface
- **charset-normalizer** for file encoding detection

## Related Tools

- [Linux Audit Scripts](https://github.com/kirkpatrickprice/linux-audit-scripts) - Data collection for Linux systems
- [Windows Audit Scripts](https://github.com/kirkpatrickprice/windows-audit-scripts) - Data collection for Windows systems  
- [macOS Auditor](https://github.com/kirkpatrickprice/macos-auditor) - Data collection for macOS systems

## Version History

The Process Scripts module evolved from the original `adv-searchfor` tool, maintaining backward compatibility while adding:
- Pydantic-based data validation
- Modern Click-based CLI interface
- Enhanced Excel export capabilities
- Improved system detection and filtering
- Comprehensive YAML configuration system

See [CHANGELOG.md](https://github.com/kirkpatrickprice/analysis-toolkit/blob/main/CHANGELOG.md) for a running history of all changes starting with 2.0.0.